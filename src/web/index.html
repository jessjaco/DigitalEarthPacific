<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
<script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />
<style>
body { margin: 0;}
#map {
  height: 100vh;
  width: 100vw;
}

</style>
</head>

<body>
  <div id="map">

  </div>
  

</body>
<script>

  class SelectControl {
    constructor(id) {
      this.element = document.createElement("select");
      this.element.className = "mapboxgl-ctrl";
    }

    onAdd(map) {
      this._map = map;
      return this.element;
    }
     
    onRemove() {
      this._container.parentNode.removeChild(this._container);
      this._map = undefined;
    }
  }

  const basestyle = {
    "version": 8,
    "sources": {
      "osm": {
        "type": "raster",
        "tiles": ["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"],
        "tileSize": 256,
        "attribution": "&copy; OpenStreetMap Contributors",
        "maxzoom": 19
      }
    },
    "layers": [
      {
        "id": "osm",
        "type": "raster",
        "source": "osm" // This must match the source key above
      }
    ]
  };

  const layers = ['evi', 'wofs'];
  const years = ['2015', '2016', '2017', '2018', '2019', '2020', '2021'];
  let activeLayer = 'evi';
  let activeYear = '2015';

  function makeVisible() {
    layers.forEach(layer => {
      years.forEach(year => {
        visible = year === activeYear && layer == activeLayer ? "visible": "none";
        Map.setLayoutProperty(`${layer}_${year}`, 'visibility', visible);
      })
    });
  }

  function changeYear(year) {
    activeYear = year;
    makeVisible();
  }

  function changeLayer(layer) {
    activeLayer = layer;
    makeVisible();
  }

  var Map = new maplibregl.Map({
    container: 'map',
    style: basestyle,
    center: [-180, -10], // starting position [lng, lat]
    zoom: 4 // starting zoom
  });

  function addData(id) {
      Map.addSource(id, {
        scheme: 'tms',
        type: 'raster',
        tiles: [`https://deppcpublicstorage.blob.core.windows.net/output/tiles/${id}/{z}/{x}/{y}.png`],
        tileSize: 512,
        maxzoom: 11
      });
      Map.addLayer({
        id: id,
        source: id,
        type: "raster",
        layout: {visibility: "none"}
      });
  }

  Map.on('load', () => {
    years.forEach((year) => {
      addData(`evi_${year}`);
      addData(`wofs_${year}`);
    });

    const layerSelector = new SelectControl("selector");
    layerSelector.element.addEventListener('change', e => {
      changeLayer(e.target.value);
    }, false);

    layers.forEach(layer => {
      const option = document.createElement("option");
      option.textContent = layer;
      option.value = layer;
      layerSelector.element.appendChild(option);
    });
    Map.addControl(layerSelector, 'top-left');

    const yearSelector = new SelectControl("selector");
    yearSelector.element.addEventListener('change', e => {
      changeYear(e.target.value);
    }, false);
    
    years.forEach(year =>{ 
      const option = document.createElement("option");
      option.textContent = year;
      option.value = year;
      yearSelector.element.appendChild(option);
    });

    Map.addControl(yearSelector, 'top-left');

    makeVisible();
  });
</script>
</html>
